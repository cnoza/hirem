---
title: "Model comparison (baseline scenario)"
author: "Christophe Nozaradan"
date: "January 2022"
output: html_document
---

```{css, echo=FALSE}
.main-container {
  max-width: 1200px; 
}

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE)
options(dplyr.summarise.inform = FALSE)
options(warn = -1)
```
## Extraction via web scraping 
We first extract the data from the simulation results stored in HTML output.

```{r}
library(tidyverse)
library(rvest)
library(scales)
rep <- './run-2/'
files <- list.files(path = rep,pattern = ".html")

settlements <- list()
payments <- list()
sizes <- list()

for(i in seq_along(files)) {

  page <- read_html(paste0(rep,files[i]))

  # settlement

  settlements[i] <- page %>% html_node(xpath = '//*[@id="evaluating-the-predictive-performance-of-the-chain-ladder-model-and-the-hierarchical-glm-and-gbm"]/pre[2]/code/text()') %>% html_text()
  settlements[i] <- regmatches(settlements[[i]], gregexpr("[[:digit:]]+.[[:digit:]]+", settlements[[i]]))

  # payment

  payments[i] <- page %>% html_node(xpath = '//*[@id="evaluating-the-predictive-performance-of-the-chain-ladder-model-and-the-hierarchical-glm-and-gbm"]/pre[4]/code/text()') %>% html_text()
  payments[i] <- regmatches(payments[i], gregexpr("[[:digit:]]+.[[:digit:]]+", payments[i]))

  # size

  sizes[i] <- page %>% html_node(xpath = '//*[@id="evaluating-the-predictive-performance-of-the-chain-ladder-model-and-the-hierarchical-glm-and-gbm"]/pre[6]/code/text()') %>% html_text()
  sizes[i] <- regmatches(sizes[i], gregexpr("[[:digit:]]+.[[:digit:]]+", sizes[i]))

}

df.settle <- as.data.frame(do.call(rbind, settlements))
names(df.settle) <- c('Actual','CL','HGLM','HGBM','HXGB','HDNN','HCANN')

df.pay <- as.data.frame(do.call(rbind, payments))
names(df.pay) <- c('Actual','CL','HGLM','HGBM','HXGB','HDNN','HCANN')

df.size <- as.data.frame(do.call(rbind, sizes))
names(df.size) <- c('Actual','CL','HGLM','HGBM','HXGB','HDNN','HCANN')
```

## Comparison
We then compute the average absolute error for settlement, payment and size:
```{r}
df.settle <- df.settle %>% mutate(error.cl=abs(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hglm=abs(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hgbm=abs(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hxgb=abs(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hdnn=abs(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hcann=abs(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

settl.error.cl <- df.settle %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
settl.error.hglm <- df.settle %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
settl.error.hgbm <- df.settle %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
settl.error.hxgb <- df.settle %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
settl.error.hdnn <- df.settle %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
settl.error.hcann <- df.settle %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = settl.error.cl, 'Hierarchical GLM' = settl.error.hglm, 'Hierarchical GBM' = settl.error.hgbm, 'Hierarchical XGB' = settl.error.hxgb, 'Hierarchical DNN' = settl.error.hdnn, 'Hierarchical CANN' = settl.error.hcann)

```

```{r}
df.pay <- df.pay %>% mutate(error.cl=abs(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hglm=abs(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hgbm=abs(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hxgb=abs(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hdnn=abs(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hcann=abs(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

payment.error.cl <- df.pay %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
payment.error.hglm <- df.pay %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
payment.error.hgbm <- df.pay %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
payment.error.hxgb <- df.pay %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
payment.error.hdnn <- df.pay %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
payment.error.hcann <- df.pay %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = payment.error.cl, 'Hierarchical GLM' = payment.error.hglm, 'Hierarchical GBM' = payment.error.hgbm, 'Hierarchical XGB' = payment.error.hxgb, 'Hierarchical DNN' = payment.error.hdnn, 'Hierarchical CANN' = payment.error.hcann)

```

```{r}
#
df.size <- df.size %>% mutate(error.cl=abs(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hglm=abs(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hgbm=abs(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hxgb=abs(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hdnn=abs(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hcann=abs(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

size.error.cl <- df.size %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
size.error.hglm <- df.size %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
size.error.hgbm <- df.size %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
size.error.hxgb <- df.size %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
size.error.hdnn <- df.size %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
size.error.hcann <- df.size %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = size.error.cl, 'Hierarchical GLM' = size.error.hglm, 'Hierarchical GBM' = size.error.hgbm, 'Hierarchical XGB' = size.error.hxgb, 'Hierarchical DNN' = size.error.hdnn, 'Hierarchical CANN' = size.error.hcann)

```

```{r}
df.settle.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.settle$error.cl, df.settle$error.hglm, df.settle$error.hgbm, 
          df.settle$error.hxgb, df.settle$error.hdnn, df.settle$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.settle <- df.settle.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (settlement)")
```

```{r}
violin.settle <- df.settle.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (settlement)")
```

```{r}
df.pay.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.pay$error.cl, df.pay$error.hglm, df.pay$error.hgbm, 
          df.pay$error.hxgb, df.pay$error.hdnn, df.pay$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.pay <- df.pay.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (payment)")
```

```{r}
violin.pay <- df.pay.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (payment)")
```


```{r}
df.size.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.size$error.cl, df.size$error.hglm, df.size$error.hgbm, 
          df.size$error.hxgb, df.size$error.hdnn, df.size$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.size <- df.size.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (size)")
```

```{r}
violin.size <- df.size.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Absolute error (size)")
```
```{r, fig.width=12, fig.height=4}
library(gridExtra)
grid.arrange(boxplot.settle,boxplot.pay,boxplot.size,ncol=3)
```

```{r, fig.width=12, fig.height=4}
library(gridExtra)
grid.arrange(violin.settle,violin.pay,violin.size,ncol=3)
```

We then compute the average relative error for settlement, payment and size:
```{r}
df.settle <- df.settle %>% mutate(error.cl=(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hglm=(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hgbm=(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hxgb=(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hdnn=(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.settle <- df.settle %>% mutate(error.hcann=(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

settl.error.cl <- df.settle %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
settl.error.hglm <- df.settle %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
settl.error.hgbm <- df.settle %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
settl.error.hxgb <- df.settle %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
settl.error.hdnn <- df.settle %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
settl.error.hcann <- df.settle %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = settl.error.cl, 'Hierarchical GLM' = settl.error.hglm, 'Hierarchical GBM' = settl.error.hgbm, 'Hierarchical XGB' = settl.error.hxgb, 'Hierarchical DNN' = settl.error.hdnn, 'Hierarchical CANN' = settl.error.hcann)

```

```{r}
df.pay <- df.pay %>% mutate(error.cl=(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hglm=(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hgbm=(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hxgb=(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hdnn=(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.pay <- df.pay %>% mutate(error.hcann=(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

payment.error.cl <- df.pay %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
payment.error.hglm <- df.pay %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
payment.error.hgbm <- df.pay %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
payment.error.hxgb <- df.pay %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
payment.error.hdnn <- df.pay %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
payment.error.hcann <- df.pay %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = payment.error.cl, 'Hierarchical GLM' = payment.error.hglm, 'Hierarchical GBM' = payment.error.hgbm, 'Hierarchical XGB' = payment.error.hxgb, 'Hierarchical DNN' = payment.error.hdnn, 'Hierarchical CANN' = payment.error.hcann)

```

```{r}
#
df.size <- df.size %>% mutate(error.cl=(as.numeric(Actual)-as.numeric(CL))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hglm=(as.numeric(Actual)-as.numeric(HGLM))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hgbm=(as.numeric(Actual)-as.numeric(HGBM))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hxgb=(as.numeric(Actual)-as.numeric(HXGB))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hdnn=(as.numeric(Actual)-as.numeric(HDNN))/as.numeric(Actual))
df.size <- df.size %>% mutate(error.hcann=(as.numeric(Actual)-as.numeric(HCANN))/as.numeric(Actual))

size.error.cl <- df.size %>% summarize(av.error=mean(error.cl)) %>% pull(av.error)
size.error.hglm <- df.size %>% summarize(av.error=mean(error.hglm)) %>% pull(av.error)
size.error.hgbm <- df.size %>% summarize(av.error=mean(error.hgbm)) %>% pull(av.error)
size.error.hxgb <- df.size %>% summarize(av.error=mean(error.hxgb)) %>% pull(av.error)
size.error.hdnn <- df.size %>% summarize(av.error=mean(error.hdnn)) %>% pull(av.error)
size.error.hcann <- df.size %>% summarize(av.error=mean(error.hcann)) %>% pull(av.error)

# Print Results
c('Chain-Ladder' = size.error.cl, 'Hierarchical GLM' = size.error.hglm, 'Hierarchical GBM' = size.error.hgbm, 'Hierarchical XGB' = size.error.hxgb, 'Hierarchical DNN' = size.error.hdnn, 'Hierarchical CANN' = size.error.hcann)

```

```{r}
df.settle.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.settle$error.cl, df.settle$error.hglm, df.settle$error.hgbm, 
          df.settle$error.hxgb, df.settle$error.hdnn, df.settle$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.settle <- df.settle.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (settlement)")
```

```{r}
violin.settle <- df.settle.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (settlement)")
```

```{r}
df.pay.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.pay$error.cl, df.pay$error.hglm, df.pay$error.hgbm, 
          df.pay$error.hxgb, df.pay$error.hdnn, df.pay$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.pay <- df.pay.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (payment)")
```

```{r}
violin.pay <- df.pay.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (payment)")
```


```{r}
df.size.error <- data.frame(
  name=c(rep("CL",100), rep("HGLM",100),rep("HGBM",100),rep("HXGB",100),rep("HDNN",100),rep("HCANN",100)) ,
  value=c(df.size$error.cl, df.size$error.hglm, df.size$error.hgbm, 
          df.size$error.hxgb, df.size$error.hdnn, df.size$error.hcann)
)

library(hrbrthemes)
library(ggplot2)
library(viridis)
boxplot.size <- df.size.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_boxplot() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (size)")
```

```{r}
violin.size <- df.size.error %>%
  ggplot( aes(x=name, y=value, fill=name)) +
    geom_violin() +
    scale_fill_viridis(discrete = TRUE, alpha=0.6) +
    theme(
      legend.position="none",
      plot.title = element_text(size=11)
    ) +
    ggtitle("") +
    xlab("") +
    ylab("Relative error (size)")
```
```{r, fig.width=12, fig.height=4}
library(gridExtra)
grid.arrange(boxplot.settle,boxplot.pay,boxplot.size,ncol=3)
```

```{r, fig.width=12, fig.height=4}
library(gridExtra)
grid.arrange(violin.settle,violin.pay,violin.size,ncol=3)
```

We now generate partial dependence plots. For this, we consider a portfolio generated with seed 1. All models were trained based on the "Baseline with seed param.Rmd" file before executing the code below. 

We obtain the following for the "type" covariate. 

```{r}
df.train <- reserving_data %>% dplyr::filter(calendar.year <= 9, open == 1)
#df.train_sample <- df.train[sample(seq_len(nrow(df.train)), size = 10000), ]

# Partial dependence plots for "type" covariate

grid_type_init <- data.frame('type' = as.factor(levels(df.train$type)))

# Response variable: settlement

grid_type_settle <- grid_type_init %>%
  dplyr::mutate(HGLM = model_glm$layers$settlement %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$settlement %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$settlement %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$settlement %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$settlement %>% par_dep(data = df.train, grid = grid_type_init))

# PDPlot

pd_type_settle <- grid_type_settle %>% reshape2::melt(id.vars = 'type',
                              value.name = 'pd_settlement',
                              variable.name = 'method') %>%
  ggplot(aes(x = type, y = pd_settlement)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

# Response variable: payment

grid_type_payment <- grid_type_init %>%
  dplyr::mutate(HGLM = model_glm$layers$payment %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$payment %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$payment %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$payment %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$payment %>% par_dep(data = df.train, grid = grid_type_init))

# PDPlot

pd_type_payment <- grid_type_payment %>% reshape2::melt(id.vars = 'type',
                             value.name = 'pd_payment',
                             variable.name = 'method') %>%
  ggplot(aes(x = type, y = pd_payment)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

# Response variable: size

grid_type_size <- grid_type_init %>%
  dplyr::mutate(HGLM = model_glm$layers$size %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$size %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$size %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$size %>% par_dep(data = df.train, grid = grid_type_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$size %>% par_dep(data = df.train, grid = grid_type_init))

# PDPlot

pd_type_size <- grid_type_size %>% reshape2::melt(id.vars = 'type',
                             value.name = 'pd_size',
                             variable.name = 'method') %>%
  ggplot(aes(x = type, y = pd_size)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

```
```{r, fig.width=12, fig.height=3}
library(gridExtra)
grid.arrange(pd_type_settle,pd_type_payment,pd_type_size,ncol=3)
```

We obtain the following for the "dev.year.fact" covariate.

```{r}
# Partial dependence plots for "dev.year.fact" covariate

grid_dev.year_init <- data.frame('dev.year.fact' = as.factor(levels(df.train$dev.year.fact)))

# Response variable: settlement

grid_dev.year_settle <- grid_dev.year_init %>%
  dplyr::mutate(HGML = model_glm$layers$settlement %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$settlement %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$settlement %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$settlement %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$settlement %>% par_dep(data = df.train, grid = grid_dev.year_init))

# PDPlot

pd_dev.year_settle <- grid_dev.year_settle %>% reshape2::melt(id.vars = 'dev.year.fact',
                              value.name = 'pd_settlement',
                              variable.name = 'method') %>%
  ggplot(aes(x = dev.year.fact, y = pd_settlement)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

# Response variable: payment

grid_dev.year_payment <- grid_dev.year_init %>%
  dplyr::mutate(HGML = model_glm$layers$payment %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$payment %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$payment %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$payment %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$payment %>% par_dep(data = df.train, grid = grid_dev.year_init))

# PDPlot

pd_dev.year_payment <- grid_dev.year_payment %>% reshape2::melt(id.vars = 'dev.year.fact',
                             value.name = 'pd_payment',
                             variable.name = 'method') %>%
  ggplot(aes(x = dev.year.fact, y = pd_payment)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

# Response variable: size

grid_dev.year_size <- grid_dev.year_init %>%
  dplyr::mutate(HGML = model_glm$layers$size %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HGBM = model_gbm$layers$size %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HXGB = model_xgb$layers$size %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HDNN = model_dnn$layers$size %>% par_dep(data = df.train, grid = grid_dev.year_init)) %>%
  dplyr::mutate(HCANN = model_cann$layers$size %>% par_dep(data = df.train, grid = grid_dev.year_init))

# PDPlot

pd_dev.year_size <- grid_dev.year_size %>% reshape2::melt(id.vars = 'dev.year.fact',
                             value.name = 'pd_size',
                             variable.name = 'method') %>%
  ggplot(aes(x = dev.year.fact, y = pd_size)) + theme_bw() +
  geom_line(aes(group = method, colour = method))

```

```{r, fig.width=12, fig.height=3}
library(gridExtra)
grid.arrange(pd_dev.year_settle,pd_dev.year_payment,pd_dev.year_size,ncol=3)
```
